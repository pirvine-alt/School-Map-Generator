<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NYC High School Map</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBQ2CKRMbhs1SMznMH1ID218WcUJ_OtyDw"></script>

    <!-- React Libraries -->
    <script type="importmap">
    {
      "imports": {
        "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
        "react/": "https://aistudiocdn.com/react@^19.2.0/",
        "react": "https://aistudiocdn.com/react@^19.2.0"
      }
    }
    </script>

    <!-- Basic Styling for the container -->
    <style>
      html, body {
        margin: 0;
        padding: 0;
        font-family: sans-serif;
      }
      /* Set a default height for the map container */
      #root {
        width: 100%;
        height: 80vh; /* You can change this to a fixed height like 600px if you prefer */
        min-height: 500px;
      }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-gray-100">
    <!-- This is the container where the React app will be rendered -->
    <div id="root"></div>

    <!-- The entire React Application bundled into a single script -->
    <script type="module">
      import React, { useState, useEffect, useCallback, useRef } from 'react';
      import ReactDOM from 'react-dom/client';

      // --- From types.ts ---
      const SchoolStatus = {
        Defined: 'Defined',
        Pending: 'Pending',
        NoService: 'No Service',
      };

      // --- From constants.ts ---
      const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/1PgcEmFohX6nwRZsMWLFRsa_JyjgXCrUIO9x-WdxMxvQ/export?format=csv&gid=0';
      const MAP_CENTER = { lat: 40.7128, lng: -74.0060 };
      const MAP_ZOOM = 11;
      const MARKER_ICONS = {
        [SchoolStatus.Defined]: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
        [SchoolStatus.Pending]: 'http://maps.google.com/mapfiles/ms/icons/yellow-dot.png',
        [SchoolStatus.NoService]: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
      };
      const CSV_COLUMN_NAMES = {
        NAME: 'School Name',
        ADDRESS: 'Street Address',
        CITY: 'City',
        STATE: 'State',
        ZIP_CODE: 'Zip Code',
        LATITUDE: 'Latitude',
        LONGITUDE: 'Longitude',
        STATUS: 'Status',
        ADMINISTRATIVE_DESIGNATION: 'Administrative Designation',
        DISTRICT: 'District',
      };

      // --- From services/googleSheetService.ts ---
      const fetchSchoolData = async (url) => {
        return new Promise((resolve, reject) => {
          Papa.parse(url, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
              try {
                const parsedData = results.data.map((row, index) => {
                  const lat = parseFloat(row[CSV_COLUMN_NAMES.LATITUDE]);
                  const lng = parseFloat(row[CSV_COLUMN_NAMES.LONGITUDE]);

                  if (isNaN(lat) || isNaN(lng)) return null;
                  
                  const sheetStatus = (row[CSV_COLUMN_NAMES.STATUS] || '').trim();
                  let status = null;

                  if (sheetStatus === 'Defined') status = SchoolStatus.Defined;
                  else if (sheetStatus === 'Pending') status = SchoolStatus.Pending;
                  else if (sheetStatus === 'No Service') status = SchoolStatus.NoService;
                  else return null;

                  const street = row[CSV_COLUMN_NAMES.ADDRESS] || '';
                  const city = row[CSV_COLUMN_NAMES.CITY] || '';
                  const state = row[CSV_COLUMN_NAMES.STATE] || '';
                  const zip = row[CSV_COLUMN_NAMES.ZIP_CODE] || '';
                  const fullAddress = [street, city, state].filter(Boolean).join(', ') + (zip ? ` ${zip}` : '');

                  return {
                    id: `${lat}-${lng}-${index}`,
                    name: row[CSV_COLUMN_NAMES.NAME] || 'Unnamed School',
                    address: fullAddress || 'No Address Provided',
                    latitude: lat,
                    longitude: lng,
                    status: status,
                    administrativeDesignation: row[CSV_COLUMN_NAMES.ADMINISTRATIVE_DESIGNATION] || 'N/A',
                    district: row[CSV_COLUMN_NAMES.DISTRICT] || 'N/A',
                  };
                }).filter(Boolean);
                resolve(parsedData);
              } catch (error) {
                reject(new Error('Failed to parse CSV data.'));
              }
            },
            error: (error) => {
              reject(new Error(`Could not fetch or parse CSV file. ${error.message}`));
            },
          });
        });
      };

      // --- From components/MapComponent.tsx ---
      const MapLegend = () => (
        React.createElement('div', { className: "absolute bottom-4 left-4 bg-white p-4 rounded-lg shadow-lg border border-gray-200 z-10" },
          React.createElement('h3', { className: "text-lg font-semibold mb-2 text-gray-800" }, "Legend"),
          React.createElement('ul', { className: "space-y-2" },
            React.createElement('li', { className: "flex items-center" },
              React.createElement('img', { src: MARKER_ICONS[SchoolStatus.Defined], alt: "Defined", className: "w-5 h-5 mr-2" }),
              React.createElement('span', { className: "text-gray-700" }, "Defined")
            ),
            React.createElement('li', { className: "flex items-center" },
              React.createElement('img', { src: MARKER_ICONS[SchoolStatus.Pending], alt: "Pending", className: "w-5 h-5 mr-2" }),
              React.createElement('span', { className: "text-gray-700" }, "Pending")
            ),
            React.createElement('li', { className: "flex items-center" },
              React.createElement('img', { src: MARKER_ICONS[SchoolStatus.NoService], alt: "No Service", className: "w-5 h-5 mr-2" }),
              React.createElement('span', { className: "text-gray-700" }, "No Service")
            )
          )
        )
      );

      const MapComponent = ({ schools, selectedSchool, onSchoolSelect }) => {
        const mapRef = useRef(null);
        const [map, setMap] = useState(null);
        const markersRef = useRef(new Map());
        const infoWindowRef = useRef(null);

        useEffect(() => {
          if (mapRef.current && !map) {
            const google = window.google;
            const newMap = new google.maps.Map(mapRef.current, {
              center: MAP_CENTER,
              zoom: MAP_ZOOM,
              mapTypeControl: false,
              streetViewControl: false,
              zoomControl: true,
              zoomControlOptions: { position: google.maps.ControlPosition.RIGHT_TOP },
              styles: [{ featureType: "poi.business", stylers: [{ visibility: "off" }] }, { featureType: "poi.park", elementType: "labels.text", stylers: [{ visibility: "off" }] }]
            });
            setMap(newMap);
            infoWindowRef.current = new google.maps.InfoWindow();
          }
        }, [map]);

        useEffect(() => {
          if (map && schools.length > 0) {
            markersRef.current.forEach(marker => marker.setMap(null));
            markersRef.current.clear();
            const infoWindow = infoWindowRef.current;
            const google = window.google;

            schools.forEach(school => {
              const marker = new google.maps.Marker({
                position: { lat: school.latitude, lng: school.longitude },
                map: map,
                title: school.name,
                icon: { url: MARKER_ICONS[school.status] },
                animation: google.maps.Animation.DROP,
              });

              const directionsUrl = `https://www.google.com/maps/dir/?api=1&destination=${school.latitude},${school.longitude}`;
              const contentString = `<div class="p-2 font-sans" style="min-width: 280px; max-width: 320px;"><h1 class="text-md font-bold text-gray-800">${school.name}</h1><p class="text-sm text-gray-500">${school.administrativeDesignation} | District: ${school.district}</p><hr class="my-2"><p class="text-gray-600">${school.address}</p><p class="text-sm mt-2">Status: <span class="font-semibold">${school.status}</span></p><a href="${directionsUrl}" target="_blank" rel="noopener noreferrer" class="inline-block mt-3 px-3 py-1 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Get Directions</a></div>`;
              
              marker.addListener('mouseover', () => {
                infoWindow.setContent(contentString);
                infoWindow.open(map, marker);
              });

              marker.addListener('click', () => {
                onSchoolSelect(school);
                infoWindow.setContent(contentString);
                infoWindow.open(map, marker);
              });
              markersRef.current.set(school.id, marker);
            });
          }
        }, [map, schools, onSchoolSelect]);
        
        useEffect(() => {
          if (map && selectedSchool) {
            const marker = markersRef.current.get(selectedSchool.id);
            if (marker) {
              map.panTo({ lat: selectedSchool.latitude, lng: selectedSchool.longitude });
              map.setZoom(15);
              window.google.maps.event.trigger(marker, 'click');
            }
          }
        }, [map, selectedSchool]);

        return React.createElement('div', { className: "relative w-full h-full" },
          React.createElement('div', { ref: mapRef, className: "w-full h-full" }),
          React.createElement(MapLegend, null)
        );
      };

      // --- From App.tsx ---
      const LoadingSpinner = () => React.createElement('div', { className: "flex flex-col items-center justify-center h-full" }, React.createElement('svg', { className: "animate-spin -ml-1 mr-3 h-10 w-10 text-blue-600", xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24" }, React.createElement('circle', { className: "opacity-25", cx: "12", cy: "12", r: "10", stroke: "currentColor", strokeWidth: "4" }), React.createElement('path', { className: "opacity-75", fill: "currentColor", d: "M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" })), React.createElement('p', { className: "mt-4 text-gray-600" }, "Loading school data..."));
      const ErrorDisplay = ({ message, details }) => React.createElement('div', { className: "flex items-center justify-center h-full bg-red-50 p-4" }, React.createElement('div', { className: "text-center max-w-2xl" }, React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className: "mx-auto h-12 w-12 text-red-500", viewBox: "0 0 20 20", fill: "currentColor" }, React.createElement('path', { fillRule: "evenodd", d: "M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z", clipRule: "evenodd" })), React.createElement('h2', { className: "mt-4 text-2xl font-bold text-red-700" }, "An Error Occurred"), React.createElement('p', { className: "mt-2 text-red-600" }, message), details && React.createElement('div', { className: "mt-4 text-sm text-left text-gray-600 bg-red-100 p-3 rounded-lg border border-red-200" }, details)));

      const waitForLibrary = (name) => new Promise((resolve, reject) => {
        let attempts = 0;
        const interval = setInterval(() => {
          if (typeof window[name] !== 'undefined') {
            clearInterval(interval);
            resolve();
          } else if (++attempts > 50) {
            clearInterval(interval);
            reject(new Error(`The '${name}' library failed to load.`));
          }
        }, 100);
      });

      const App = () => {
        const [schools, setSchools] = useState([]);
        const [isLoading, setIsLoading] = useState(true);
        const [error, setError] = useState(null);
        const [searchTerm, setSearchTerm] = useState('');
        const [selectedSchool, setSelectedSchool] = useState(null);
        const [lastUpdated, setLastUpdated] = useState(null);

        const loadData = useCallback(async () => {
          setIsLoading(true);
          setError(null);
          try {
            await waitForLibrary('google');
            await waitForLibrary('Papa');
            const data = await fetchSchoolData(GOOGLE_SHEET_CSV_URL);
            setSchools(data);
            setLastUpdated(new Date());
          } catch (err) {
            setError({ message: err.message });
          } finally {
            setIsLoading(false);
          }
        }, []);

        useEffect(() => { loadData(); }, [loadData]);
        
        const handleSearch = (e) => {
          e.preventDefault();
          const foundSchool = schools.find(s => s.name.toLowerCase().includes(searchTerm.toLowerCase()));
          if (foundSchool) setSelectedSchool(foundSchool);
          else alert(`No school found matching "${searchTerm}".`);
        };

        const renderContent = () => {
          if (isLoading && schools.length === 0) return React.createElement(LoadingSpinner, null);
          if (error) return React.createElement(ErrorDisplay, { message: error.message });
          return React.createElement(MapComponent, { schools, selectedSchool, onSchoolSelect: setSelectedSchool });
        };

        return React.createElement('div', { className: "flex flex-col h-screen font-sans" },
          React.createElement('header', { className: "bg-white shadow-md z-20" },
            React.createElement('div', { className: "max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8" },
              React.createElement('div', { className: "flex flex-wrap justify-between items-center gap-4" },
                React.createElement('h1', { className: "text-2xl sm:text-3xl font-bold leading-tight text-gray-900" }, "NYC High Schools Status Map"),
                !isLoading && !error && React.createElement('div', { className: "flex items-center gap-2 w-full sm:w-auto" },
                  React.createElement('form', { onSubmit: handleSearch, className: "flex-grow flex" },
                    React.createElement('input', { type: "text", placeholder: "Search school name...", value: searchTerm, onChange: e => setSearchTerm(e.target.value), className: "w-full sm:w-64 px-3 py-2 border border-gray-300 rounded-l-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" }),
                    React.createElement('button', { type: "submit", className: "inline-flex items-center px-4 py-2 border border-l-0 border-gray-300 text-sm font-medium rounded-r-md bg-gray-50 hover:bg-gray-100 focus:outline-none" }, React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className: "h-5 w-5 text-gray-500", viewBox: "0 0 20 20", fill: "currentColor" }, React.createElement('path', { fillRule: "evenodd", d: "M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z", clipRule: "evenodd" })))
                  ),
                  React.createElement('button', { onClick: loadData, disabled: isLoading, className: "inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50" }, 
                    isLoading ? React.createElement('svg', { className: "animate-spin h-5 w-5 text-gray-700", xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24" }, React.createElement('circle', { className: "opacity-25", cx: "12", cy: "12", r: "10", stroke: "currentColor", strokeWidth: "4" }), React.createElement('path', { className: "opacity-75", fill: "currentColor", d: "M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" })) : React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className: "h-5 w-5 text-gray-500", viewBox: "0 0 20 20", fill: "currentColor" }, React.createElement('path', { fillRule: "evenodd", d: "M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.899 2.223 1 1 0 01-1.79 1.026A5.002 5.002 0 005.999 7H8a1 1 0 010 2H3a1 1 0 01-1-1V3a1 1 0 011-1zm12 14a1 1 0 01-1-1v-2.101a7.002 7.002 0 01-11.899-2.223 1 1 0 011.79-1.026A5.002 5.002 0 0014.001 13H12a1 1 0 010-2h5a1 1 0 011 1v5a1 1 0 01-1 1z", clipRule: "evenodd" }))
                  )
                )
              ),
              lastUpdated && !error && React.createElement('p', { className: "text-xs text-gray-500 mt-2 text-right w-full" }, `Last updated: ${lastUpdated.toLocaleString()}`)
            )
          ),
          React.createElement('main', { className: "flex-grow relative" }, renderContent())
        );
      };

      // --- Final render call ---
      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }
      const root = ReactDOM.createRoot(rootElement);
      root.render(React.createElement(React.StrictMode, null, React.createElement(App)));

    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
